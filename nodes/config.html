<script type="text/html" data-template-name="seqera-config">
  <div class="form-row">
    <label for="node-config-input-baseUrl">Base URL</label>
    <input type="text" id="node-config-input-baseUrl" placeholder="https://api.cloud.seqera.io" />
  </div>

  <div class="form-row">
    <label for="node-config-input-token">
      <a href="https://cloud.seqera.io/tokens" target="_blank" style="color: var(--red-ui-text-color-link)">
        API Token
        <i class="fa fa-external-link"></i>
      </a>
    </label>
    <input type="password" id="node-config-input-token" placeholder="Bearer token" autocomplete="off" />
  </div>
  <div class="form-row">
    <label for="node-config-input-workspaceId">Workspace&nbsp;ID</label>
    <input type="number" id="node-config-input-workspaceId" placeholder="(optional)" />
  </div>
  <hr />
  <h4>Connectivity check</h4>
  <div id="connectivity-status">
    <p id="connectivity-message">No API token</p>
    <div id="connectivity-spinner" style="display: none;">
      <i class="fa fa-spinner fa-spin"></i> Checking connection...
    </div>
  </div>
</script>

<script type="text/markdown" data-help-name="seqera-config">
  Global Seqera Platform configuration node to store connection details.

  ### Details

  Configure the following options:

  - **Base URL**: The base URL for the Seqera API (defaults to `https://api.cloud.seqera.io`)
  - **Workspace ID**: Your Seqera workspace ID (optional)
  - **API Token**: Your personal access token for authenticating with Seqera Platform. Create a Seqera access token via [_Your Tokens_](https://cloud.seqera.io/tokens) in the user menu.

  This configuration node is used by all other Seqera nodes to authenticate with the Seqera Platform API.

  ### References

  - [Seqera Platform API docs](https://docs.seqera.io/platform/latest/api) - information on how to get an API token
</script>

<script type="text/javascript">
  RED.nodes.registerType("seqera-config", {
    category: "config",
    defaults: {
      baseUrl: { value: "https://api.cloud.seqera.io", required: true },
      workspaceId: { value: null },
    },
    credentials: {
      token: { type: "password" },
    },
    label: function () {
      const wsPart = this.workspaceId ? `, WS ${this.workspaceId}` : "";
      return this.baseUrl ? `Seqera (${this.baseUrl}${wsPart})` : "Seqera config";
    },
    oneditprepare: function () {
      let debounceTimer;
      const debounceDelay = 1000; // 1 second debounce

      function updateConnectivityStatus(message, isValid = null, userInfo = null) {
        const statusElement = document.getElementById("connectivity-message");
        const spinnerElement = document.getElementById("connectivity-spinner");

        spinnerElement.style.display = "none";

        if (isValid === null) {
          // Neutral state
          statusElement.innerHTML = message;
          statusElement.style.color = "";
        } else if (isValid) {
          // Valid connection
          const displayMessage = userInfo
            ? `<span style="color: green;">✓ Connected as ${userInfo.userName} (${userInfo.email})</span>`
            : `<span style="color: green;">✓ ${message}</span>`;
          statusElement.innerHTML = displayMessage;
        } else {
          // Invalid connection
          statusElement.innerHTML = `<span style="color: red;">✗ ${message}</span>`;
        }
      }

      function showSpinner() {
        document.getElementById("connectivity-spinner").style.display = "block";
        document.getElementById("connectivity-message").innerHTML = "";
      }

      async function checkConnectivity() {
        const baseUrl = document.getElementById("node-config-input-baseUrl").value.trim();
        const token = document.getElementById("node-config-input-token").value.trim();

        if (!token) {
          updateConnectivityStatus("No API token");
          return;
        }

        if (!baseUrl) {
          updateConnectivityStatus("No base URL specified", false);
          return;
        }

        showSpinner();

        try {
          const queryParams = new URLSearchParams({
            baseUrl: baseUrl,
            token: token,
          });

          const response = await fetch(`/seqera-config/connectivity-check?${queryParams}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              updateConnectivityStatus("API token is valid", true, data.user);
            } else {
              if (data.isEmptyToken) {
                updateConnectivityStatus("No API token");
              } else {
                updateConnectivityStatus(data.message, false);
              }
            }
          } else {
            updateConnectivityStatus("Server error occurred", false);
          }
        } catch (error) {
          console.error("Connectivity check error:", error);
          updateConnectivityStatus("Connection failed - unable to reach server", false);
        }
      }

      function debouncedCheckConnectivity() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(checkConnectivity, debounceDelay);
      }

      // Check connectivity when the dialog opens
      setTimeout(checkConnectivity, 100);

      // Add event listeners for token and base URL changes
      document.getElementById("node-config-input-token").addEventListener("input", debouncedCheckConnectivity);
      document.getElementById("node-config-input-baseUrl").addEventListener("input", debouncedCheckConnectivity);
    },
  });
</script>
